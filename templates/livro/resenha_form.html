{% extends "_base.html" %}
{% load static %}

{% block content %}

<style>
    /* Estrelas */
    .star {
        font-size: 35px;
        cursor: pointer;
        color: #ccc;
        /* cor padrão (cinza) */
        transition: color .12s;
        user-select: none;
        display: inline-block;
        margin-right: 6px;
    }

    /* Estrela ativa (amarela) */
    .star.active {
        color: #f5c518;
    }

    /* Quando o formulário estiver desabilitado, reduzir contraste */
    .form-disabled .star {
        opacity: 0.6;
        cursor: default;
    }
</style>

<div class="container mt-4" style="max-width: 700px;">
    <div class="d-flex align-items-center gap-2 mb-2">
        <button class="btn p-0 border-0 bg-transparent d-flex align-items-center" onclick="history.back()">
            <i class="fas fa-chevron-left fs-5"></i>
        </button>

        <h2 class="mb-0">Avaliar Livro</h2>
    </div>


    <div class="card shadow-sm p-4">

        <!-- INFORMAÇÕES DO LIVRO -->
        <div class="d-flex align-items-center mb-3">
            {% if livro.capa %}
            <img src="{{ livro.capa }}" alt="Capa do livro" class="me-3"
                style="width: 90px; height: auto; border-radius: 4px;">
            {% endif %}

            <div>
                <h4 class="mb-0">{{ livro.titulo }}</h4>
                <small class="text-muted">{{ livro.autor }}</small>
            </div>
        </div>

        {% if resenha_existente %}
        <div class="alert alert-info">
            Você já avaliou este livro com <strong>{{ resenha_existente.nota }} estrelas</strong>.
        </div>
        {% endif %}

        <!-- ADICIONA classe "form-disabled" se já houver resenha -->
        <form method="POST" class="{% if resenha_existente %}form-disabled{% endif %}">
            {% csrf_token %}

            <label class="form-label fw-bold">Sua Nota</label>

            <div class="rating mb-3">

                <input type="hidden" name="nota" id="notaInput" value="{{ resenha_existente.nota|default:'0' }}">

                {# Itera sobre a lista de inteiros enviada pela view #}
                {% for i in stars %}
                <span class="star {% if resenha_existente and resenha_existente.nota >= i %}active{% endif %}"
                    data-value="{{ i }}" title="{{ i }} estrela{% if i > 1 %}s{% endif %}">
                    ★
                </span>
                {% endfor %}
            </div>

            <div class="mb-3">
                <label class="form-label fw-bold">Sua Resenha</label>
                <textarea name="comentario" class="form-control" rows="5" placeholder="Escreva aqui sua opinião..." 
                {% if resenha_existente %}disabled{% endif %}>{{ resenha_existente.comentario }}</textarea>

            </div>

            <button class="btn btn-primary w-100" type="submit" {% if resenha_existente %}disabled{% endif %}>
                Enviar Resenha
            </button>
        </form>

    </div>
</div>

<script>
    const stars = document.querySelectorAll('.star');
    const notaInput = document.getElementById('notaInput');

    stars.forEach(star => {
        star.addEventListener('click', (e) => {
            // se o formulário estiver desabilitado, não permite clicar
            if (notaInput.closest('form').classList.contains('form-disabled')) return;

            const value = parseInt(star.getAttribute('data-value'), 10);
            notaInput.value = value;

            // remove active de todas e aplica às <= value
            stars.forEach(s => s.classList.remove('active'));
            stars.forEach(s => {
                if (parseInt(s.getAttribute('data-value'), 10) <= value) {
                    s.classList.add('active');
                }
            });
        });

        // efeito hover (opcional): mostra visual de pré-seleção
        star.addEventListener('mouseenter', () => {
            if (notaInput.closest('form').classList.contains('form-disabled')) return;
            const value = parseInt(star.getAttribute('data-value'), 10);
            stars.forEach(s => s.classList.remove('active'));
            stars.forEach(s => {
                if (parseInt(s.getAttribute('data-value'), 10) <= value) {
                    s.classList.add('active');
                }
            });
        });
    });

    // Ao sair da área, volta ao valor selecionado (ou ao valor existente)
    const ratingWrapper = document.querySelector('.rating');
    ratingWrapper.addEventListener('mouseleave', () => {
        // se já existe resenha, pintar com base nela; senão, usar o input
        const current = parseInt(notaInput.value || 0, 10);
        stars.forEach(s => s.classList.remove('active'));
        if (current > 0) {
            stars.forEach(s => {
                if (parseInt(s.getAttribute('data-value'), 10) <= current) {
                    s.classList.add('active');
                }
            });
        }
    });
</script>

{% endblock %}