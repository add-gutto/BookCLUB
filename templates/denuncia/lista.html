{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container-fluid">

    <h1 class="h3 mb-4 text-gray-800">Painel de Denúncias</h1>

    <!-- Card de filtros -->
    <div class="card shadow mb-4">
        <div class="card-body">

            <div class="row mb-3">
                <div class="col-md-6">
                    <input id="busca" type="text" class="form-control" placeholder="Buscar denúncia...">
                </div>

                <div class="col-md-4">
                    <select id="statusFiltro" class="form-select">
                        <option value="">Todos os status</option>
                        <option value="pendente">Pendente</option>
                        <option value="em_analise">Em análise</option>
                        <option value="resolvido">Resolvido</option>
                    </select>
                </div>

                <div class="col-md-2 d-grid">
                    <button id="btnBuscar" class="btn btn-primary">
                        <i class="bi bi-search"></i> Buscar
                    </button>
                </div>
            </div>

        </div>
    </div>

    <!-- Card da tabela -->
    <div class="card shadow mb-4">
        <div class="card-body">

            <div class="table-responsive">
                <table class="table table-bordered">
                    <thead class="table-light">
                        <tr>
                            <th>ID</th>
                            <th>Título</th>
                            <th>Autor</th>
                            <th>Status</th>
                            <th>Alvo</th>
                            <th>Data</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody id="tabelaDenuncias">
                        <!-- AJAX insere aqui -->
                    </tbody>
                </table>
            </div>

            <div id="paginacao" class="mt-3 d-flex justify-content-center">
                <!-- AJAX insere paginação -->
            </div>

        </div>
    </div>

</div>

<script>
    document.addEventListener("DOMContentLoaded", () => {

        function carregar(pagina = 1) {
            const q = document.getElementById("busca").value;
            const status = document.getElementById("statusFiltro").value;

            fetch(`/denuncia/ajax/buscar/?page=${pagina}&q=${q}&status=${status}`)
                .then(response => response.json())
                .then(data => {

                    let html = "";
                    data.resultados.forEach(d => {
                        html += `
                    <tr>
                        <td>${d.id}</td>
                        <td>${d.titulo}</td>
                        <td>${d.autor}</td>
                        <td><span class="badge bg-${d.status == "pendente" ? "warning" : d.status == "em_analise" ? "info" : "success"}">${d.status}</span></td>
                        <td>${d.alvo_tipo} #${d.alvo_id}</td>
                        <td>${d.created_at}</td>
                        <td>
                            <a href="/denuncia/${d.id}/" class="btn btn-sm btn-primary">
                                <i class="bi bi-eye"></i>
                            </a>
                        </td>
                    </tr>
                `;
                    });

                    document.getElementById("tabelaDenuncias").innerHTML = html;

                    // Paginação
                    let pag = "";
                    for (let i = 1; i <= data.total_paginas; i++) {
                        pag += `<button class="btn btn-sm btn-${i === data.pagina_atual ? "primary" : "outline-primary"} me-1" onclick="carregar(${i})">${i}</button>`;
                    }
                    document.getElementById("paginacao").innerHTML = pag;

                });
        }

        document.getElementById("btnBuscar").onclick = () => carregar();
        carregar();
    });
</script>

{% endblock %}