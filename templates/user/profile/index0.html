{% extends '_base.html' %}
{% load static %}
{% block content %}
<div class="container my-5">
    <div class="row justify-content-center flex-lg-row flex-column">

        <!-- Conteúdo principal do perfil -->
        <div class="col-lg-8 order-1 order-lg-1">
            <div class="card border-0 overflow-hidden">

                <!-- Capa -->
                <img src="{% if profile and profile.thumbnail %}{{ profile.thumbnail.url }}{% else %}{% static 'template/img/placeholder_thumb.jpeg' %}{% endif %}"
                    alt="Capa do perfil" class="img-fluid rounded-top"
                    style="width: 100%; height: 200px; object-fit: cover;">


                <!-- Corpo do card -->
                <div class="card-body border">

                    <!-- Linha superior: avatar + nome + estatísticas -->
                    <div class="row align-items-center">

                        <!-- Esquerda: avatar e nome -->
                        <div class="col-md-6 d-flex flex-wrap align-items-center">
                            <div class="position-relative me-3" style="margin-top: -100px;">
                                <img src="{% if profile and profile.profile_picture %}{{ profile.profile_picture.url }}{% else %}{% static 'template/img/placeholder.jpg' %}{% endif %}"
                                    alt="Avatar" class="rounded-circle border border-4 border-white shadow" width="200"
                                    height="200">
                            </div>
                            <div class="mt-4">
                                <h4 class="fw-bold mb-1 ">{% if profile and profile.name %}{{ profile.name }}{% else
                                    %}{{ user.username }}{% endif %}</h4>
                                <h6 class="text-muted mb-1">@{{ user.username }}</h6>
                            </div>
                        </div>

                        <!-- Direita: estatísticas -->
                        <div class="col-md-6 d-flex flex-wrap justify-content-around text-center mt-4 mt-md-0">
                            <div>
                                <h4 class="fw-bold mb-0">{{ total_resenhas }}</h4>
                                <small class="text-secondary d-block fs-6">Posts</small>
                            </div>
                            <div>
                                <h4 class="fw-bold mb-0">{{ seguidores.count }}</h4>
                                <small class="text-secondary d-block fs-6">Followers</small>
                            </div>
                            <div>
                                <h4 class="fw-bold mb-0">{{ seguindo.count }}</h4>
                                <small class="text-secondary d-block fs-6">Following</small>
                            </div>
                        </div>
                    </div>

                    <!-- Bio justificada -->
                    <div class="mt-4 mx-auto" style="max-width: 700px;">
                        <p class="text-secondary" style="text-align: justify;">{% if profile %}{{ profile.bio }}{% endif
                            %}
                        </p>
                    </div>

                    <div class="d-flex justify-content-end gap-3">
                        {% if user == request.user %}
                        <a href="{% url 'editar_profile' %}" class="btn btn-primary px-5 py-2 fw-semibold">
                            Editar Perfil
                        </a>
                        <!--<a class="btn btn-secondary px-5 py-2 fw-semibold">
                            Compartilhar Perfil
                        </a> -->
                        {% else %}
                        <form method="POST" action="{% url 'seguir_usuario' user.id %}">
                            {% csrf_token %}
                            {% if is_seguindo %}
                            <button type="submit" class="btn btn-primary px-5 py-2 fw-semibold">Seguindo</button>
                            {% elif is_seguido_por %}
                            <button type="submit" class="btn btn-primary px-5 py-2 fw-semibold">Seguir de Volta</button>
                            {% else %}
                            <button type="submit" class="btn btn-primary px-5 py-2 fw-semibold">Seguir</button>
                            {% endif %}
                        </form>

                        <a class="btn btn-secondary px-5 py-2 fw-semibold">
                            Mensagem
                        </a>
                        {% endif %}
                    </div>

                </div>
            </div>

            <!-- Resenhas -->
            <div class="mt-4">
                <h5 class="mb-3">Resenhas ({{ total_resenhas }})</h5>

                {% for resenha in resenhas %}
                <div class="card mb-3">
                    <div class="row g-0">
                        <div class="col-auto p-3">
                            {% if profile and profile.profile_picture %}
                            <img src="{{ profile.profile_picture.url }}" class="rounded-circle" width="64" height="64">
                            {% else %}
                            <img src="{% static 'template/img/placeholder.jpg' %}" class="rounded-circle" width="64"
                                height="64">
                            {% endif %}
                        </div>
                        <div class="col">
                            <div class="card-body">
                                <div class="d-flex align-items-center mb-2">
                                    <img src="{% if resenha.livro.capa %}{{ resenha.livro.capa }}{% else %}{% static 'template/img/placeholderimage.jpg' %}{% endif %}"
                                        alt="Capa do livro" style="width:48px; height:68px; object-fit:cover;"
                                        class="me-3">
                                    <div>
                                        <strong>{{ resenha.livro.titulo }}</strong>
                                        <div class="text-muted small">por {{ resenha.livro.autor }}</div>
                                    </div>
                                    <div class="ms-auto text-end small text-muted">{{ resenha.criado_em|date:'d M Y' }}
                                    </div>
                                </div>

                                <p class="mb-1">{{ resenha.comentario|default:"(sem comentário)" }}</p>

                                <div>
                                    <span class="badge bg-primary me-2">Nota: {{ resenha.nota }}/5</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% empty %}
                <div class="text-secondary">Este usuário ainda não escreveu resenhas.</div>
                {% endfor %}

            </div>

        </div>

        <!-- Sidebar / Sinopse (visível apenas no desktop) -->
        <div class="col-lg-4 mt-4 mt-lg-0 d-none d-lg-block order-lg-2">
            <div class="card border">
                <div class="card-body">
                    <h4 class="fw-semibold mb-3">Sinopse</h4>
                    <p style="text-align: justify;">
                        Aqui você pode colocar informações adicionais do usuário, links e estatísticas.
                    </p>
                </div>
            </div>
        </div>

    </div>
</div>
{% endblock %}