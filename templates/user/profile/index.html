{% extends '_base.html' %}
{% load static %}
{% block content %}
<div class="container my-5">
    <div class="row justify-content-center flex-lg-row flex-column">

        <!-- Conteúdo principal do perfil -->
        <div class="col-lg-8 order-1 order-lg-1">
            <div class="card border-0 overflow-hidden">

                <!-- Capa -->
                <img src="{% if user.profile.thumbnail %}{{ user.profile.thumbnail.url }}{% else %}{% static 'template/img/placeholder_thumb.jpeg' %}{% endif %}"
                    alt="Capa do perfil" class="img-fluid rounded-top"
                    style="width: 100%; height: 200px; object-fit: cover;">

                <!-- Corpo do card -->
                <div class="card-body border">

                    <!-- Linha superior: avatar + nome + estatísticas -->
                    <div class="row align-items-center">

                        <!-- Esquerda: avatar e nome -->
                        <div class="col-md-6 d-flex flex-wrap align-items-center">
                            <div class="position-relative me-3" style="margin-top: -100px;">
                                <img src="{% if user.profile.profile_picture %}{{ user.profile.profile_picture.url }}{% else %}{% static 'template/img/placeholder.jpg' %}{% endif %}"
                                    alt="Avatar" class="rounded-circle border border-4 border-white shadow" width="200"
                                    height="200">
                            </div>
                            <div class="mt-4">
                                <h4 class="fw-bold mb-1">{{ user.profile.name }}</h4>
                                <h6 class="text-muted mb-1">@{{ user.username }}</h6>
                            </div>
                        </div>

                        <!-- Direita: estatísticas -->
                        <div class="col-md-6 d-flex flex-wrap justify-content-around text-center mt-4 mt-md-0">
                            <div>
                                <h4 class="fw-bold mb-0">{{ user.resenhas.count }}</h4>
                                <small class="text-secondary d-block fs-6">Livros Lidos</small>
                            </div>
                            <div>
                                <h4 class="fw-bold mb-0">{{ user.seguidores.count }}</h4>
                                <small class="text-secondary d-block fs-6">Seguidores</small>
                            </div>
                            <div>
                                <h4 class="fw-bold mb-0">{{ user.seguindo.count }}</h4>
                                <small class="text-secondary d-block fs-6">Seguindo</small>
                            </div>
                        </div>
                    </div>

                    <!-- Bio -->
                    <div class="mt-4 mx-auto" style="max-width: 700px;">
                        <p class="text-secondary" style="text-align: justify;">{{ user.profile.bio }}</p>
                    </div>

                    <div class="d-flex justify-content-end gap-3">
                        {% if user == request.user %}
                        <a href="{% url 'editar_profile' %}" class="btn btn-primary px-5 py-2 fw-semibold">
                            Editar Perfil
                        </a>
                        {% else %}
                        <form method="POST" action="{% url 'seguir_usuario' user.id %}">
                            {% csrf_token %}
                            {% if is_seguindo %}
                            <button type="submit" class="btn btn-primary px-5 py-2 fw-semibold">Seguindo</button>
                            {% elif is_seguido_por %}
                            <button type="submit" class="btn btn-primary px-5 py-2 fw-semibold">Seguir de Volta</button>
                            {% else %}
                            <button type="submit" class="btn btn-primary px-5 py-2 fw-semibold">Seguir</button>
                            {% endif %}
                        </form>

                        {% endif %}
                    </div>

                </div>
            </div>

            <!-- Livros Favoritos - Mobile -->
            <div class="card border mt-4 d-lg-none">
                <div class="card-body">
                    <h4 class="fw-semibold mb-3">Livros Favoritos</h4>

                    {% if favoritos %}
                    {% for fav in favoritos %}
                    <div class="d-flex align-items-center mb-3">

                        <img src="{% if fav.livro.capa %}{{ fav.livro.capa.url }}{% else %}{% static 'template/img/placeholderimage.jpg' %}{% endif %}"
                            alt="Capa do livro" style="width:60px; height:80px; object-fit:cover;" class="me-3 rounded">

                        <div>
                            <strong>{{ fav.livro.titulo }}</strong><br>
                            <span class="text-muted small">por {{ fav.livro.autor }}</span>
                        </div>

                    </div>
                    {% endfor %}
                    {% else %}
                    <p class="text-muted">Nenhum livro favorito ainda.</p>
                    {% endif %}
                </div>
            </div>


            <!-- Lista de Resenhas -->
            <div class="mt-4">
                {% for resenha in resenhas %}
                <div class="card border-top-0 mb-4">
                    <div class="card-body">

                        <!-- Cabeçalho da resenha -->
                        <div class="d-flex align-items-center gap-3">
                            <img src="{% if user.profile.profile_picture %}{{ user.profile.profile_picture.url }}{% else %}{% static 'template/img/placeholder.jpg' %}{% endif %}"
                                alt="Avatar" class="rounded-circle" width="64" height="64">

                            <div>
                                <h6 class="fw-semibold mb-0 fs-5">{{ user.profile.name }}</h6>
                                <span class="text-muted small">{{ resenha.criado_em }}</span>
                            </div>
                        </div>

                        <!-- Comentário -->
                        <p class="text-dark my-3">{{ resenha.comentario }}</p>

                        <!-- Bloco do livro -->
                        <div class="p-4 rounded-2 bg-light">

                            <div class="d-flex align-items-start">
                                <img src="{% if resenha.livro.capa %}{{ resenha.livro.capa.url }}{% else %}{% static 'template/img/placeholderimage.jpg' %}{% endif %}"
                                    alt="Capa do livro" style="width:100px; height:120px; object-fit:cover;"
                                    class="me-3">

                                <div>
                                    <strong>{{ resenha.livro.titulo }}</strong>
                                    <div class="text-muted small">por {{ resenha.livro.autor }}</div>

                                    <!-- Estrelas -->
                                    <div class="mt-2">
                                        {% for i in "12345" %}
                                        {% if forloop.counter <= resenha.nota %} <span class="text-warning fs-6">
                                            ★</span>
                                            {% else %}
                                            <span class="text-muted fs-6">☆</span>
                                            {% endif %}
                                            {% endfor %}
                                    </div>
                                </div>
                            </div>

                        </div>

                    </div>
                </div>
                {% endfor %}
            </div>

        </div>

        <!-- Livros Favoritos - Desktop -->
        <div class="col-lg-4 mt-4 mt-lg-0 d-none d-lg-block order-lg-2">
            <div class="card border">
                <div class="card-body">
                    <h4 class="fw-semibold mb-3">Livros Favoritos</h4>

                    {% if favoritos %}
                    {% for fav in favoritos %}
                    <div class="d-flex align-items-center mb-3">

                        <img src="{% if fav.livro.capa %}{{ fav.livro.capa.url }}{% else %}{% static 'template/img/placeholderimage.jpg' %}{% endif %}"
                            alt="Capa do livro" style="width:60px; height:80px; object-fit:cover;" class="me-3 rounded">

                        <div>
                            <strong>{{ fav.livro.titulo }}</strong><br>
                            <span class="text-muted small">por {{ fav.livro.autor }}</span>
                        </div>

                    </div>
                    {% endfor %}
                    {% else %}
                    <p class="text-muted">Nenhum livro favorito ainda.</p>
                    {% endif %}
                </div>
            </div>
        </div>


    </div>
</div>
{% endblock %}